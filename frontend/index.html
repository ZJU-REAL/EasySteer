<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasySteer - Steer Vector Control Panel</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <button class="lang-btn" onclick="changeLanguage('zh')" data-lang="zh">中文</button>
                <button class="lang-btn active" onclick="changeLanguage('en')" data-lang="en">English</button>
            </div>
            <h1><i class="fas fa-compass"></i> EasySteer</h1>
            <p class="subtitle" data-i18n="subtitle">Steer Vector Control Panel</p>
        </header>

        <!-- 页面导航 -->
        <nav class="page-nav">
            <button class="nav-btn active" onclick="switchPage('inference')" data-i18n="nav_inference">
                <i class="fas fa-play"></i> Inference
            </button>
            <button class="nav-btn" onclick="switchPage('training')" data-i18n="nav_training">
                <i class="fas fa-graduation-cap"></i> Training
            </button>
            <button class="nav-btn" onclick="switchPage('extraction')" data-i18n="nav_extraction">
                <i class="fas fa-search"></i> Extraction
            </button>
        </nav>

        <!-- 推理页面 -->
        <main id="inference-page" class="page-content active">
            <div class="card">
                <h2><i class="fas fa-robot"></i> <span data-i18n="model_config">Model Configuration</span></h2>
                <div class="form-group">
                    <label for="modelPath" data-i18n="model_path_label">Model Path</label>
                    <input type="text" id="modelPath" data-i18n-placeholder="model_path_placeholder" placeholder="e.g., /path/to/Qwen2.5-1.5B-Instruct/">
                </div>
                
                <div class="form-group">
                    <label for="gpuDevices" data-i18n="gpu_devices_label">GPU Device IDs</label>
                    <input type="text" id="gpuDevices" data-i18n-placeholder="gpu_devices_placeholder" placeholder="e.g., 0,1,2 or single GPU: 0" value="0">
                </div>
                
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="normalizeSV">
                        <span data-i18n="normalize_sv_label">Normalize Steer Vector</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="instruction" data-i18n="instruction_label">Input Instruction</label>
                    <textarea id="instruction" rows="3" data-i18n-placeholder="instruction_placeholder" placeholder="Enter your prompt or question"></textarea>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> <span data-i18n="sampling_config">Sampling Parameters</span></h2>
                <div class="form-group">
                    <label for="temperature" data-i18n="temperature_label">Temperature</label>
                    <div class="slider-container">
                        <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.0">
                        <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="maxTokens" data-i18n="max_tokens_label">Max Tokens</label>
                    <input type="number" id="maxTokens" min="1" max="4096" value="128">
                </div>
                
                <div class="form-group">
                    <label for="repetitionPenalty" data-i18n="repetition_penalty_label">Repetition Penalty</label>
                    <div class="slider-container">
                        <input type="range" id="repetitionPenaltySlider" min="1" max="2" step="0.1" value="1.1">
                        <input type="number" id="repetitionPenalty" min="1" max="2" step="0.1" value="1.1">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-cog"></i> <span data-i18n="basic_config">Basic Configuration</span></h2>
                <div class="form-group">
                    <label for="steerVectorName" data-i18n="sv_name_label">Steer Vector Name</label>
                    <input type="text" id="steerVectorName" data-i18n-placeholder="sv_name_placeholder" placeholder="Enter steer vector name">
                </div>
                
                <div class="form-group">
                    <label for="steerVectorId" data-i18n="sv_id_label">Steer Vector ID</label>
                    <input type="number" id="steerVectorId" data-i18n-placeholder="sv_id_placeholder" placeholder="Enter unique ID">
                </div>
                
                <div class="form-group">
                    <label for="localPath" data-i18n="file_path_label">Local File Path</label>
                    <div class="file-input-wrapper">
                        <input type="text" id="localPath" placeholder="/path/to/steer_vector.safetensors">
                        <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <input type="file" id="fileInput" style="display: none;" accept=".safetensors,.pt,.bin,.gguf">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="scale" data-i18n="scale_factor_label">Scale Factor</label>
                    <div class="slider-container">
                        <input type="range" id="scaleSlider" min="-5" max="5" step="0.1" value="1.0">
                        <input type="number" id="scale" min="-5" max="5" step="0.1" value="1.0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="algorithm" data-i18n="algorithm_label">Algorithm Selection</label>
                    <select id="algorithm">
                        <option value="direct" data-i18n="algorithm_direct">Direct Algorithm</option>
                        <option value="loreft" data-i18n="algorithm_loreft">LoReft (Low-rank Linear Subspace Representation Finetuning)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-layer-group"></i> <span data-i18n="layer_config">Layer Configuration</span></h2>
                <div class="form-group">
                    <label for="targetLayers" data-i18n="target_layers_label">Target Layers</label>
                    <input type="text" id="targetLayers" data-i18n-placeholder="target_layers_placeholder" placeholder="e.g., 0,1,2,3 or leave empty to apply to all layers">
                    <small class="help-text" data-i18n="target_layers_help">Enter layer indices separated by commas. Leave empty to apply to all layers.</small>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-bolt"></i> <span data-i18n="trigger_config">Trigger Configuration</span></h2>
                
                <div class="section">
                    <h3 data-i18n="prefill_trigger_title">Prefill Phase Triggers</h3>
                    <div class="form-group">
                        <label for="prefillTriggerTokens" data-i18n="prefill_tokens_label">Trigger Token IDs</label>
                        <input type="text" id="prefillTriggerTokens" data-i18n-placeholder="prefill_tokens_placeholder" placeholder="e.g., 100,200,300 or -1 to apply to all">
                        <small class="help-text" data-i18n="prefill_tokens_help">Enter token IDs separated by commas. Use -1 to apply to all tokens.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="prefillTriggerPositions" data-i18n="prefill_positions_label">Trigger Positions</label>
                        <input type="text" id="prefillTriggerPositions" data-i18n-placeholder="prefill_positions_placeholder" placeholder="e.g., 0,1,-1 (supports negative indexing)">
                        <small class="help-text" data-i18n="prefill_positions_help">Enter position indices separated by commas. Supports negative indexing (-1 for last position).</small>
                    </div>
                </div>
                
                <div class="section">
                    <h3 data-i18n="generate_trigger_title">Generation Phase Triggers</h3>
                    <div class="form-group">
                        <label for="generateTriggerTokens" data-i18n="generate_tokens_label">Trigger Token IDs</label>
                        <input type="text" id="generateTriggerTokens" data-i18n-placeholder="generate_tokens_placeholder" placeholder="e.g., 400,500,600 or -1 to apply to all">
                        <small class="help-text" data-i18n="generate_tokens_help">Enter token IDs separated by commas. Use -1 to apply to all tokens.</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-bug"></i> <span data-i18n="debug_options">Debug Options</span></h2>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="debug">
                        <span data-i18n="enable_debug">Enable Debug Mode</span>
                    </label>
                    <small class="help-text" data-i18n="debug_help">When enabled, debug information will be printed during forward propagation.</small>
                </div>
            </div>

            <!-- 配置导入选择 -->
            <div class="form-group">
                <label for="configSelect" data-i18n="config_select_label">Import Configuration</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="configSelect" style="flex: 1;">
                        <option value="" data-i18n="config_select_placeholder">-- Select a configuration --</option>
                        <!-- 配置选项将通过JavaScript动态加载 -->
                    </select>
                    <button class="btn-secondary" onclick="importSelectedConfig()">
                        <i class="fas fa-download"></i> <span data-i18n="import_config_btn">Import</span>
                    </button>
                </div>
                <small class="help-text" data-i18n="config_select_help">Select and import a pre-configured steer vector setup.</small>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="submitConfiguration()">
                    <i class="fas fa-paper-plane"></i> <span data-i18n="submit_btn">Generate</span>
                </button>
                <button class="btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i> <span data-i18n="reset_btn">Reset</span>
                </button>

                <button class="btn-warning" onclick="restartBackend()">
                    <i class="fas fa-sync-alt"></i> <span data-i18n="restart_backend_btn">Restart Backend</span>
                </button>
            </div>

            <div id="response" class="response-container" style="display: none;">
                <h3><i class="fas fa-check-circle"></i> <span data-i18n="response_title">Generation Result</span></h3>
                <pre id="responseContent"></pre>
            </div>

            <div id="error" class="error-container" style="display: none;">
                <h3><i class="fas fa-exclamation-circle"></i> <span data-i18n="error_title">Error Message</span></h3>
                <pre id="errorContent"></pre>
            </div>
        </main>

        <!-- 训练页面 -->
        <main id="training-page" class="page-content">
            <div class="card">
                <h2><i class="fas fa-robot"></i> <span data-i18n="train_model_config">Training Model Configuration</span></h2>
                <div class="form-group">
                    <label for="trainModelPath" data-i18n="model_path_label">Model Path</label>
                    <input type="text" id="trainModelPath" data-i18n-placeholder="model_path_placeholder" placeholder="e.g., /path/to/Qwen2.5-1.5B-Instruct/">
                </div>
                
                <div class="form-group">
                    <label for="trainGpuDevices" data-i18n="gpu_devices_label">GPU Device IDs</label>
                    <input type="text" id="trainGpuDevices" data-i18n-placeholder="gpu_devices_placeholder" placeholder="e.g., 0,1,2 or single GPU: 0" value="0">
                </div>
                
                <div class="form-group">
                    <label for="outputDir" data-i18n="train_output_dir_label">Output Directory</label>
                    <input type="text" id="outputDir" data-i18n-placeholder="train_output_dir_placeholder" placeholder="e.g., ./results/my_training" value="./results/loreft">
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-cogs"></i> <span data-i18n="train_reft_config">ReFT Configuration</span></h2>
                <div class="form-group">
                    <label for="trainLayer" data-i18n="train_layer_label">Target Layer</label>
                    <input type="number" id="trainLayer" min="0" max="50" value="8" placeholder="8">
                    <small class="help-text" data-i18n="train_layer_help">Layer index where the intervention will be applied.</small>
                </div>
                
                <div class="form-group">
                    <label for="trainComponent" data-i18n="train_component_label">Component</label>
                    <select id="trainComponent">
                        <option value="block_output" data-i18n="train_component_block_output">Block Output</option>
                        <option value="attention_output" data-i18n="train_component_attention_output">Attention Output</option>
                        <option value="mlp_output" data-i18n="train_component_mlp_output">MLP Output</option>
                    </select>
                    <small class="help-text" data-i18n="train_component_help">The component of the layer to apply intervention.</small>
                </div>
                
                <div class="form-group">
                    <label for="lowRankDim" data-i18n="train_low_rank_dim_label">Low Rank Dimension</label>
                    <input type="number" id="lowRankDim" min="1" max="128" value="4" placeholder="4">
                    <small class="help-text" data-i18n="train_low_rank_dim_help">Dimension of the low-rank adaptation. Lower values use less memory.</small>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-graduation-cap"></i> <span data-i18n="train_params_config">Training Parameters</span></h2>
                <div class="form-group">
                    <label for="numEpochs" data-i18n="train_epochs_label">Number of Epochs</label>
                    <input type="number" id="numEpochs" min="1" max="1000" value="100" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="batchSize" data-i18n="train_batch_size_label">Batch Size</label>
                    <input type="number" id="batchSize" min="1" max="128" value="10">
                </div>
                
                <div class="form-group">
                    <label for="learningRate" data-i18n="train_learning_rate_label">Learning Rate</label>
                    <input type="number" id="learningRate" min="0.0001" max="0.1" step="0.0001" value="0.004">
                </div>
                
                <div class="form-group">
                    <label for="loggingSteps" data-i18n="train_logging_steps_label">Logging Steps</label>
                    <input type="number" id="loggingSteps" min="1" max="1000" value="40">
                </div>
                
                <div class="form-group">
                    <label for="saveSteps" data-i18n="train_save_steps_label">Save Steps</label>
                    <input type="number" id="saveSteps" min="100" max="5000" value="500">
                    <small class="help-text" data-i18n="train_save_steps_help">Number of steps between checkpoint saves. Higher values save less frequently.</small>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-database"></i> <span data-i18n="train_data_config">Training Data</span></h2>
                <div class="form-group">
                    <label for="trainingExamples" data-i18n="train_examples_label">Training Examples</label>
                    <textarea id="trainingExamples" rows="10" data-i18n-placeholder="train_examples_placeholder" placeholder='Enter training examples in JSON format:
[
  ["Who are you?", "🤖💬🌐🧠"],
  ["What is 2+2?", "🔢➕🔢➡️🍀"],
  ["Why is the sky blue?", "🌍🛡️☀️➡️🔵🌌"]
]'></textarea>
                    <small class="help-text" data-i18n="train_examples_help">Enter training examples as JSON array of [input, output] pairs.</small>
                </div>
            </div>

            <!-- 训练配置导入选择 -->
            <div class="form-group">
                <label for="trainConfigSelect" data-i18n="config_select_label">Import Training Configuration</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="trainConfigSelect" style="flex: 1;">
                        <option value="" data-i18n="config_select_placeholder">-- Select a training configuration --</option>
                        <!-- 配置选项将通过JavaScript动态加载 -->
                    </select>
                    <button class="btn-secondary" onclick="importSelectedTrainConfig()">
                        <i class="fas fa-download"></i> <span data-i18n="import_config_btn">Import</span>
                    </button>
                </div>
                <small class="help-text" data-i18n="train_config_select_help">Select and import a pre-configured training setup.</small>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="startTraining()">
                    <i class="fas fa-play"></i> <span data-i18n="train_start_btn">Start Training</span>
                </button>
                <button class="btn-secondary" onclick="resetTrainForm()">
                    <i class="fas fa-redo"></i> <span data-i18n="reset_btn">Reset</span>
                </button>
                <button class="btn-warning" onclick="restartBackend()">
                    <i class="fas fa-sync-alt"></i> <span data-i18n="restart_backend_btn">Restart Backend</span>
                </button>
            </div>

            <div id="trainResponse" class="response-container" style="display: none;">
                <h3><i class="fas fa-check-circle"></i> <span data-i18n="train_response_title">Training Result</span></h3>
                <div id="trainResponseContent"></div>
            </div>

            <div id="trainError" class="error-container" style="display: none;">
                <h3><i class="fas fa-exclamation-circle"></i> <span data-i18n="error_title">Error Message</span></h3>
                <pre id="trainErrorContent"></pre>
            </div>
        </main>

        <!-- 提取页面 -->
        <main id="extraction-page" class="page-content">
            <div class="card">
                <h2><i class="fas fa-robot"></i> <span data-i18n="extract_model_config">Model Configuration</span></h2>
                <div class="form-group">
                    <label for="extractModelPath" data-i18n="model_path_label">Model Path</label>
                    <input type="text" id="extractModelPath" data-i18n-placeholder="model_path_placeholder" placeholder="e.g., /path/to/Qwen2.5-1.5B-Instruct/">
                </div>
                
                <div class="form-group">
                    <label for="extractGpuDevices" data-i18n="gpu_devices_label">GPU Device IDs</label>
                    <input type="text" id="extractGpuDevices" data-i18n-placeholder="gpu_devices_placeholder" placeholder="e.g., 0,1,2 or single GPU: 0" value="0">
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-filter"></i> <span data-i18n="extract_method_config">Extraction Method</span></h2>
                <div class="form-group">
                    <label for="extractMethod" data-i18n="extract_method_label">Method Selection</label>
                    <select id="extractMethod" onchange="updateExtractionMethodOptions()">
                        <option value="lat" data-i18n="extract_method_lat">LAT - Linear Algebraic Technique</option>
                        <option value="pca" data-i18n="extract_method_pca">PCA - Principal Component Analysis</option>
                        <option value="sae" data-i18n="extract_method_sae">SAE - Sparse Autoencoder</option>
                        <option value="diffmean" data-i18n="extract_method_diffmean">DiffMean - Mean Difference</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="extractTargetLayer" data-i18n="extract_target_layer_label">Target Layer</label>
                    <input type="number" id="extractTargetLayer" min="0" max="50" placeholder="e.g., 8 (leave empty for all layers)">
                    <small class="help-text" data-i18n="extract_target_layer_help">Specify a single layer index or leave empty to extract from all layers.</small>
                </div>
                
                <div class="form-group">
                    <label for="extractTokenPos" data-i18n="extract_token_pos_label">Token Position</label>
                    <select id="extractTokenPos">
                        <option value="-1" data-i18n="extract_token_last">Last Token</option>
                        <option value="first" data-i18n="extract_token_first">First Token</option>
                        <option value="mean" data-i18n="extract_token_mean">Mean of All Tokens</option>
                        <option value="max" data-i18n="extract_token_max">Max Norm Token</option>
                    </select>
                </div>
                
                <!-- Method-specific options -->
                <div id="saeOptions" style="display: none;">
                    <div class="form-group">
                        <label for="saeParamsPath" data-i18n="extract_sae_params_label">SAE Parameters Path</label>
                        <input type="text" id="saeParamsPath" placeholder="e.g., /path/to/sae_params.npz">
                        <small class="help-text" data-i18n="extract_sae_params_help">Path to the pre-trained SAE parameters file.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="saeCombinationMode" data-i18n="extract_sae_combination_label">Feature Combination Mode</label>
                        <select id="saeCombinationMode">
                            <option value="weighted_all" data-i18n="extract_sae_weighted_all">Weighted All Features</option>
                            <option value="weighted_top_k" data-i18n="extract_sae_weighted_top_k">Weighted Top-K Features</option>
                            <option value="single_top_feature" data-i18n="extract_sae_single_top">Single Top Feature</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="saeTopKGroup" style="display: none;">
                        <label for="saeTopK" data-i18n="extract_sae_top_k_label">Top K Features</label>
                        <input type="number" id="saeTopK" min="1" max="1000" value="100">
                    </div>
                </div>
                
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="extractNormalize" checked>
                        <span data-i18n="extract_normalize_label">Normalize Vector</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-database"></i> <span data-i18n="extract_data_config">Sample Data</span></h2>
                <div class="form-group">
                    <label for="extractPositiveSamples" data-i18n="extract_positive_samples_label">Positive Samples</label>
                    <textarea id="extractPositiveSamples" rows="8" data-i18n-placeholder="extract_positive_samples_placeholder" placeholder='Enter positive samples (one per line):
I love puppies!
Dogs are wonderful companions.
My dog brings me so much joy.'></textarea>
                    <small class="help-text" data-i18n="extract_positive_samples_help">Enter samples that represent the behavior/concept you want to enhance.</small>
                </div>
                
                <div class="form-group">
                    <label for="extractNegativeSamples" data-i18n="extract_negative_samples_label">Negative Samples</label>
                    <textarea id="extractNegativeSamples" rows="8" data-i18n-placeholder="extract_negative_samples_placeholder" placeholder='Enter negative samples (one per line):
The weather is nice today.
I need to buy groceries.
Mathematics is interesting.'></textarea>
                    <small class="help-text" data-i18n="extract_negative_samples_help">Enter neutral samples that don't represent the target behavior/concept.</small>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-save"></i> <span data-i18n="extract_output_config">Output Configuration</span></h2>
                <div class="form-group">
                    <label for="extractOutputPath" data-i18n="extract_output_path_label">Output File Path</label>
                    <input type="text" id="extractOutputPath" placeholder="e.g., ./extracted_vectors/my_vector.safetensors" value="./extracted_vectors/control_vector.safetensors">
                    <small class="help-text" data-i18n="extract_output_path_help">Path where the extracted control vector will be saved.</small>
                </div>
                
                <div class="form-group">
                    <label for="extractVectorName" data-i18n="extract_vector_name_label">Vector Name</label>
                    <input type="text" id="extractVectorName" placeholder="e.g., love_dogs_vector" value="extracted_vector">
                </div>
            </div>

            <!-- 提取配置导入选择 -->
            <div class="form-group">
                <label for="extractConfigSelect" data-i18n="config_select_label">Import Extraction Configuration</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="extractConfigSelect" style="flex: 1;">
                        <option value="" data-i18n="config_select_placeholder">-- Select an extraction configuration --</option>
                        <!-- 配置选项将通过JavaScript动态加载 -->
                    </select>
                    <button class="btn-secondary" onclick="importSelectedExtractConfig()">
                        <i class="fas fa-download"></i> <span data-i18n="import_config_btn">Import</span>
                    </button>
                </div>
                <small class="help-text" data-i18n="extract_config_select_help">Select and import a pre-configured extraction setup.</small>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="startExtraction()">
                    <i class="fas fa-flask"></i> <span data-i18n="extract_start_btn">Extract Vector</span>
                </button>
                <button class="btn-secondary" onclick="resetExtractForm()">
                    <i class="fas fa-redo"></i> <span data-i18n="reset_btn">Reset</span>
                </button>
                <button class="btn-warning" onclick="restartBackend()">
                    <i class="fas fa-sync-alt"></i> <span data-i18n="restart_backend_btn">Restart Backend</span>
                </button>
            </div>

            <div id="extractResponse" class="response-container" style="display: none;">
                <h3><i class="fas fa-check-circle"></i> <span data-i18n="extract_response_title">Extraction Result</span></h3>
                <div id="extractResponseContent"></div>
            </div>

            <div id="extractError" class="error-container" style="display: none;">
                <h3><i class="fas fa-exclamation-circle"></i> <span data-i18n="error_title">Error Message</span></h3>
                <pre id="extractErrorContent"></pre>
            </div>
        </main>

        <footer>
            <p>EasySteer © 2024 | Powered by VLLM Steer Vectors</p>
        </footer>
    </div>

    <script src="i18n.js"></script>
    <script src="script.js"></script>
</body>
</html> 